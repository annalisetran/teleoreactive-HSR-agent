% Test script for near_static(StaticObj) guard
% Usage: qcc test_near_static.qlg && rlwrap qp
%        ?- load(test_near_static).
%        ?- go().

?- pconsult(clean_the_table_interface)
?- consult(world_knowledge)

def object_term ::= object(int, int, position_term, atom)
def position_term ::= position(num, num, num)

tel_percept
	robot_base_x(num),
	robot_base_y(num),
	robot_base_z(num),
	robot_base_r(num),
	robot_base_p(num),
	robot_base_yw(num),
	driveable_state(atom),
	holding_object_id(int),
	region_id(int),
	scene_objects(list(object_term))

% Declare write_list as a TeleoR action
tel_action
    log_output(list(term))

act start_node_thread(list(tel_percept_term), tel_percept_term)
rel get_percepts(?list(tel_percept_term))

fun distance_3d(num, num, num, num, num, num) -> num
distance_3d(X1, Y1, Z1, X2, Y2, Z2) ->
	sqrt((X2-X1)*(X2-X1) + (Y2-Y1)*(Y2-Y1) + (Z2-Z1)*(Z2-Z1))

rel near_static(!atom)
near_static(StaticObj) <=
	robot_base_x(X) & robot_base_y(Y) & robot_base_z(Z) &
	static_object_location(StaticObj, _, LocX, LocY, LocZ) &
	Dist = distance_3d(X, Y, Z, LocX, LocY, LocZ) &
	Dist < 2

init_percept_handler() ~>
    start_node_thread([
        robot_base_x(0.0),
        robot_base_y(0.0),
        robot_base_z(0.0),
        robot_base_r(0.0),
        robot_base_p(0.0),
        robot_base_yw(0.0),
        driveable_state(true),
        holding_object_id(-1),
        region_id(-1)
    ], scene_objects([]));
    thread_sleep(1)

poll_sensors(P) ::
	get_percepts(P) ~> {}

% Map log_output to write_list
control_device(_OldActions, [log_output(Message)]) ~>
    write_list(Message)

control_device(_OldActions, []) ~> {}

tel test_near_static()
test_near_static() {
    robot_base_x(X) & robot_base_y(Y) & robot_base_z(Z) &
    static_object_location(table, _, LocX, LocY, LocZ) &
    Dist = distance_3d(X, Y, Z, LocX, LocY, LocZ) ~>
        log_output(["Robot position: (", X, ", ", Y, ", ", Z, ")", nl_,
                    "Table position: (", LocX, ", ", LocY, ", ", LocZ, ")", nl_,
                    "Distance: ", Dist, " meters", nl_,
                    "Threshold: 2.0 meters", nl_])
    
    near_static(table) ~> 
        log_output(["PASS: near_static(table) - Robot is near the table!", nl_])
    
    true ~> 
        log_output(["FAIL: not near_static(table) - Robot is too far from table", nl_])
}

tel test_coordinator()
test_coordinator() {
    true ~> () ++ start_task(test_near_static(), _)
}

act go()
go() ~>
    write_list(["Testing near_static(table) guard...", nl_]);
    start_embedded_agent(1.0);
    start_task(test_coordinator(), _)