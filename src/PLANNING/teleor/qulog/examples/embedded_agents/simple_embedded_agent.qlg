%% Copyright 2019 Keith Clark, Peter Robinson
%%
%% Licensed under the Apache License, Version 2.0 (the "License");
%% you may not use this file except in compliance with the License.
%% You may obtain a copy of the License at
%%
%%     http://www.apache.org/licenses/LICENSE-2.0
%%
%% Unless required by applicable law or agreed to in writing, software
%% distributed under the License is distributed on an "AS IS" BASIS,
%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
%% express or implied.
%% See the License for the specific language governing permissions and
%% limitations under the License.

%% This is a very simple example of an embedded TR agent - it is a simplified
%% version of the ev3 agent in the ev3 subdirectory.

%% The touch sensors of the ev3 agent are simulated by remembering touch
%% facts for a short time.
%% Instead of really controlling motors we simply display the controls.
%%
%% To run:
%% teleor
%% [simple_embedded_agent].
%% go().

%% Now try combinations of
%% t(0).
%% t(1).
%% t(0);t(1).
%% to observe the displayed controls

%% fact to simulate ev3_touch for the ev3 agent
dyn touch(nat, nat)
%% to make life easy for the user - remember the required touch fact for 0.3
%% secs
act t(nat)
t(N) ~> remember_for([touch(N, 1)], 3)

    
def dir ::= left | right

tel_percept touched(dir)

tel_action move(int, int)

tel frighten()

frighten() {
    
    touched(left) & touched(right) or_while  min_time 2 ~> move(-50, -50)
    
    touched(left)  or_while min_time 2 ~> move(-50, -20)
    
    touched(right) or_while min_time 2 ~> move(-20, -50)
    
    true ~> ()
    }

act go() 
go() ~>
    start_embedded_agent(0.1); %% poll sensors every 0.1 secs
    start_task(ev3, frighten())
    
%% A system declared but user defined action - 
%% must be defined for embedded agents
poll_sensors(P) :: 
    P = [touched(Dir) :: Dir in [left,right] & is_touched(Dir)] ~> {}
    
rel is_touched(dir)

%% the ev3 agent uses ev3_touch(Sensor, Value) which is true if
%% the touch sensor Sensor (0 or 1) is pressed (1 for yes, 0 for no)
is_touched(left) <= touch(0, 1)
is_touched(right) <= touch(1, 1)

%% A system declared but user defined action - 
%% must be defined for embedded agents
%% normally control_device would, for example, control motors as in the ev3
%% agent example
control_device(OldActions, NewActions) ~>
    write_list(["Old Actions ", OldActions, " New Actions ", NewActions, nl_])

